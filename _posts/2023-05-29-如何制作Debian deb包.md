---
layout: post
title: 如何制作Debian deb包
categories: 工具教程 debian deb
---

## deb包的组成结构

- 数据: 包含实际安装的程序数据以及安装目录 ，文件权限等，文件名为 data.tar；
- 控制信息：安装包信息及控制脚本包, 包含deb的安装说明，标识，脚本等，文件名为 control.tar.gz；

## dpkg-deb功能说明

1.  制作deb包

```
dpkg-deb -b <dir> <deb>
```

上命的命令可以将一个目录打包为deb文件，要求这个目录下有`DEBIAN`这个目录，并包含必要的控制文件。
2. 查看deb包的文件内容

```
dpkg-deb -c google-chrome-stable_current_amd64.deb
```

可打印出deb中所包含的文件信息，类似如下：

```
drwxr-xr-x root/root         0 2023-03-25 05:40 ./
drwxr-xr-x root/root         0 2023-03-25 05:40 ./etc/
drwxr-xr-x root/root         0 2023-03-25 05:40 ./etc/cron.daily/
drwxr-xr-x root/root         0 2023-03-25 05:40 ./opt/
drwxr-xr-x root/root         0 2023-03-25 05:40 ./opt/google/
drwxr-xr-x root/root         0 2023-03-25 05:40 ./opt/google/chrome/
drwxr-xr-x root/root         0 2023-03-25 05:40 ./opt/google/chrome/MEIPreload/
-rw-r--r-- root/root       238 2023-03-25 05:40 ./opt/google/chrome/MEIPreload/manifest.json
-rw-r--r-- root/root      8254 2023-03-25 05:40 ./opt/google/chrome/MEIPreload/preloaded_data.pb
```

3.  查看控制文件中的内容
    命令：

```
dpkg-deb -I <deb> <cfile>
```

使用`-I`参数可以打印控制文件内容，`cfile`可以是`DEBIAN`目录下的任意文件，如`control`, `postinst`等。
示例：

```
$ dpkg-deb -I google-chrome-stable_current_amd64.deb control
Package: google-chrome-stable
Version: 111.0.5563.146-1
Architecture: amd64
Maintainer: Chrome Linux Team <chromium-dev@chromium.org>
Installed-Size: 310369
Pre-Depends: dpkg (>= 1.14.0)
Depends: ca-certificates, fonts-liberation, libasound2 (>= 1.0.17), libatk-bridge2.0-0 (>= 2.5.3), libatk1.0-0 (>= 2.2.0)
Provides: www-browser
Section: web
Priority: optional
Description: The web browser from Google
 Google Chrome is a browser that combines a minimal design with sophisticated technology to make the web faster, safer, and easier.
```

4.  解压出控制信息与文件
    命令：

```
dpkg-deb -R <deb> <directory>
```

当我们想要查看一个deb包的所有内容时，可以使用`-R`参数，将控制文件和数据文件解压到一个目录中，示例：

```
$ dpkg-deb -R google-chrome-stable_current_amd64.deb chrome
$ ls -l chrome
total 16
drwxr-xr-x 2 kevin kevin 4096  3月 25 05:40 DEBIAN
drwxr-xr-x 3 kevin kevin 4096  3月 25 05:40 etc
drwxr-xr-x 3 kevin kevin 4096  3月 25 05:40 opt
drwxr-xr-x 4 kevin kevin 4096  3月 25 05:40 usr
```

## 控制文件说明

- control
    用于记录包名，版本号，架构，依赖信息等。
    示例模版：

```
Package: google-chrome-stable
Version: 111.0.5563.146-1
Architecture: amd64
Maintainer: Chrome Linux Team <chromium-dev@chromium.org>
Installed-Size: 310369
Pre-Depends: dpkg (>= 1.14.0)
Depends: ca-certificates, fonts-liberation, libasound2 (>= 1.0.17), libatk-bridge2.0-0 (>= 2.5.3), libatk1.0-0 (>= 2.2.0)
Provides: www-browser
Section: web
Priority: optional
Description: The web browser from Google
 Google Chrome is a browser that combines a minimal design with sophisticated technology to make the web faster, safer, and easier.
```

`control`包含一下字段：

```
Package (必须)
Source
Version (必须)
Section (推荐有)
Priority (推荐有)
Architecture (必须)
Essential
Depends et al
Installed-Size
Maintainer (必须)
Description (必须)
Homepage
Built-Using
```

- preinst
    在解包data.tar前运行的脚本
    示例模版:

```shell
#!/bin/sh
# preinst script for exchanger
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    install|upgrade)
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
```

- postinst
    在解包data.tar后运行的脚本
    示例模版:

```shell
#!/bin/sh
# postinst script for exchanger
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
        #systemctl enable exchanger.service
        systemctl enable trustserver.service
        ln -srf /opt/jdwa/etc/ulogd_rsyslog.conf /etc/rsyslog.d/ulogd_rsyslog.conf
        systemctl enable jdwa-ulogd.service
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
```

- prerm
    卸载时，在删除文件之前运行的脚本
    示例模版:

```shell
#!/bin/sh
# prerm script for exchanger
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <prerm> `remove'
#        * <old-prerm> `upgrade' <new-version>
#        * <new-prerm> `failed-upgrade' <old-version>
#        * <conflictor's-prerm> `remove' `in-favour' <package> <new-version>
#        * <deconfigured's-prerm> `deconfigure' `in-favour'
#          <package-being-installed> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    remove|upgrade|deconfigure)
        systemctl disable exchanger.service
        systemctl stop exchanger.service
        rm -f /opt/jdwa/etc/exchanger.json
    ;;

    failed-upgrade)
    ;;

    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
```

- postrm
    卸载时，在删除文件之后运行的脚本

```
#!/bin/sh
# postrm script for exchanger
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postrm> `remove'
#        * <postrm> `purge'
#        * <old-postrm> `upgrade' <new-version>
#        * <new-postrm> `failed-upgrade' <old-version>
#        * <new-postrm> `abort-install'
#        * <new-postrm> `abort-install' <old-version>
#        * <new-postrm> `abort-upgrade' <old-version>
#        * <disappearer's-postrm> `disappear' <overwriter>
#          <overwriter-version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
```

## 制作DEB包

了解了deb包的构造后，制作deb包就比较简单了，我们使用`dpkg-deb`这个工具来进行打包。假设我目的项目为`example`。

1.  创建一个打包目录，如在代码根目录下创建一个`debian`目录，这个目录为deb包的根目录；
2.  在打包目录下创建目录`DEBIAN`，将控制文件放在这个目录下，如`control`, 此时打包目录结构应为：

```
debian/
└── DEBIAN
    ├── control
    ├── postinst
    ├── postrm
    └── prerm
```

4.  使用自己的编译方式将代码进行编译。
5.  将编译好的程序copy到打包目录`debian`中，此时打包目录结构应为：

```
debian/
├── DEBIAN
│   ├── control
│   ├── postinst
│   ├── postrm
│   └── prerm
└── usr
     └── bin
        └── example
```

6.  使用dpkg-deb将打包目录打包为deb文件：

```shell
fakeroot dpkg-deb -b debian example_1.0.0_amd64.deb
```
**fakeroot**是为了让deb包中的内容所有者为root。


